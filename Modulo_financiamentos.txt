Beleza, vamos montar um **super-prompt** prontinho para voc√™ colar na IA do VSCode.
A ideia √©: voc√™ cola o texto abaixo como ‚Äúcontexto/sistema‚Äù e depois s√≥ vai pedindo para ela ir executando as fases.

Vou te entregar o documento direto, sem coment√°rios meus, pra voc√™ copiar e usar.

---

## üìÑ DOCUMENTO PARA A IA DO VSCODE

**Implementa√ß√£o Completa do M√≥dulo de Financiamentos no Sistema de Controle Financeiro**

> **IMPORTANTE ‚Äì LEIA ANTES DE QUALQUER ALTERA√á√ÉO**
> Voc√™ √© uma IA integrada ao VSCode, com acesso ao reposit√≥rio de um sistema de controle financeiro pessoal desenvolvido em **Python + Flask + SQLAlchemy + SQLite** e preparado para PostgreSQL.
> Seu objetivo √© **implementar um m√≥dulo completo de FINANCIAMENTOS**, seguindo √† risca as instru√ß√µes abaixo, sem pular etapas e sempre preservando o estilo e a arquitetura j√° existentes no projeto.

---

### 1. Papel e comportamento da IA

1. **Antes de alterar qualquer arquivo**, voc√™ deve:

   * Ler a estrutura do projeto (`backend/`, `frontend/`, `data/`, etc.).
   * Ler o arquivo `README.md`.
   * Ler `backend/app.py`, `backend/models.py`, pasta `backend/routes/` e `backend/services/`.
2. **Sempre que for propor mudan√ßas:**

   * Explique em 2‚Äì5 frases o que vai fazer.
   * Liste quais arquivos ser√£o alterados/criados.
   * Mostre o c√≥digo em blocos claramente separados por arquivo.
   * Evite reescrever arquivos gigantes inteiros se for alterar apenas trechos; prefira mostrar **trechos novos** e explicar onde encaixar.
3. **Coer√™ncia com o projeto existente:**

   * Use os mesmos padr√µes de nomenclatura, estilo de c√≥digo, organiza√ß√£o de rotas e services que j√° existem no sistema (ex.: `orcamento_service`, `consorcio_service`, rotas em `routes/xxx.py`).
   * Respeite o padr√£o dos modelos SQLAlchemy j√° existentes.
4. **Sobre migra√ß√µes:**

   * Gere o c√≥digo de migra√ß√£o (fun√ß√µes `upgrade` e `downgrade`) compat√≠vel com Flask-Migrate.
   * Se n√£o puder executar comandos, explique claramente quais comandos eu devo rodar no terminal (`flask db migrate`, `flask db upgrade`).
5. **Sobre riscos:**

   * N√£o apague funcionalidades existentes.
   * Se precisar refatorar algo grande, proponha primeiro e aguarde minha confirma√ß√£o.

---

### 2. Contexto resumido do projeto

O sistema j√° possui:

* Separa√ß√£o **Back-end** (Flask) e **Front-end** (HTML/CSS/JS).
* Banco de dados via SQLAlchemy, com:

  * M√≥dulo de **Or√ßamento** (categorias, itens de despesa, contas a pagar, receitas, cart√µes, etc.).
  * M√≥dulo de **Automa√ß√£o ‚Äì Cons√≥rcios** (tabela `contrato_consorcio` + gera√ß√£o autom√°tica de parcelas).
  * M√≥dulo de **Patrim√¥nio** (caixinhas/contas de patrim√¥nio e transfer√™ncias).
* Funcionalidades importantes j√° implementadas:

  * **Rastreamento de Pagamentos**: compara√ß√£o entre valor previsto e valor pago.
  * Gera√ß√£o autom√°tica de despesas/parcelas a partir de contratos (cons√≥rcios).

O novo m√≥dulo de **Financiamentos** deve seguir a mesma filosofia e arquitetura.

---

### 3. Objetivo do novo m√≥dulo de Financiamentos

Criar um m√≥dulo que permita:

1. Cadastrar **contratos de financiamento** (imobili√°rio, ve√≠culos, empr√©stimos em geral).
2. Gerar automaticamente um **cronograma de parcelas** com:

   * Amortiza√ß√£o
   * Juros
   * Seguros
   * Taxas administrativas
   * Atualiza√ß√£o pela TR (indexador)
3. Registrar **amortiza√ß√µes extraordin√°rias**, recalculando as parcelas futuras:

   * Redu√ß√£o de prazo
   * Redu√ß√£o de valor da parcela
4. Integrar com o m√≥dulo de **contas a pagar** e com o **rastreamento Previsto x Real** j√° existente.
5. Permitir a visualiza√ß√£o de demonstrativos parecidos com:

   * **Demonstrativo de Valores Cobrados ‚Äì Ano Base** (CAIXA)
   * **Demonstrativo de Evolu√ß√£o ‚Äì Habita√ß√£o**
     Incluindo:
   * Prazo total e remanescente
   * Saldo devedor te√≥rico
   * Juros do m√™s
   * Amortiza√ß√£o do m√™s
   * Composi√ß√£o detalhada da presta√ß√£o
   * DIF (diferen√ßa de pagamento) por parcela

---

### 4. Modelo de dados a ser criado/expandido

#### 4.1. Nova tabela: `financiamento`

Criar um modelo SQLAlchemy `Financiamento` em `backend/models.py`, representando o contrato principal.

Campos m√≠nimos:

* `id` ‚Äì PK
* `nome` ‚Äì string (ex.: ‚ÄúFinanciamento Im√≥vel Caixa SFH‚Äù)
* `produto` ‚Äì string (ex.: ‚ÄúSFH‚Äù)
* `sistema_amortizacao` ‚Äì string (`'SAC'`, `'PRICE'`, `'SIMPLES'`)
* `valor_financiado` ‚Äì Numeric
* `prazo_total_meses` ‚Äì Integer
* `prazo_remanescente_meses` ‚Äì Integer (atualizado conforme o pagamento/amortiza√ß√£o)
* `taxa_juros_nominal_anual` ‚Äì Numeric
* `taxa_juros_efetiva_anual` ‚Äì Numeric (opcional)
* `taxa_juros_efetiva_relacionamento_anual` ‚Äì Numeric (opcional)
* `taxa_juros_mensal` ‚Äì Numeric (pode ser derivada, mas armazenar facilita relat√≥rios)
* `indexador_saldo` ‚Äì string (ex.: `'TR'`)
* `data_contrato` ‚Äì Date
* `data_primeira_parcela` ‚Äì Date
* `item_despesa_id` ‚Äì FK para o item de despesa que representa esse financiamento
* `ativo` ‚Äì Boolean (soft delete)

Criar relacionamento com `FinanciamentoParcela`.

---

#### 4.2. Nova tabela: `financiamento_parcela`

Criar modelo `FinanciamentoParcela` em `backend/models.py`, ligado a `Financiamento`.

Campos:

* `id` ‚Äì PK
* `financiamento_id` ‚Äì FK para `Financiamento`
* `numero_parcela` ‚Äì Integer (1, 2, 3, ‚Ä¶)
* `data_vencimento` ‚Äì Date
* **Componentes da presta√ß√£o (A ‚Äì Componentes do Encargo Mensal):**

  * `valor_amortizacao` ‚Äì Numeric
  * `valor_juros` ‚Äì Numeric
  * `valor_seguro` ‚Äì Numeric
  * `valor_taxa_adm` ‚Äì Numeric
* **Descontos / Abatimentos (B ‚Äì FGTS/Subs√≠dio):**

  * `valor_subsidio` ‚Äì Numeric (opcional)
  * `valor_fgts_utilizado` ‚Äì Numeric (opcional)
* **Encargos por atraso (C):**

  * `valor_juros_mora` ‚Äì Numeric
  * `valor_multa` ‚Äì Numeric
  * `valor_atualizacao_monetaria` ‚Äì Numeric
  * `valor_iof_complementar` ‚Äì Numeric
* **Valores consolidados:**

  * `valor_previsto_total` ‚Äì Numeric (soma de todos os componentes da parcela)
  * `valor_pago` ‚Äì Numeric (o que efetivamente foi pago, integrado ao m√≥dulo de execu√ß√£o/contas)
  * `dif_apurada` ‚Äì Numeric (diferen√ßa entre valor te√≥rico da parcela e valor pago no m√™s, igual √† coluna ‚ÄúDIF Apurada no m√™s‚Äù)
* **Status e v√≠nculos:**

  * `conta_id` ‚Äì FK opcional, para integrar com a tabela de contas a pagar j√° existente
  * `status` ‚Äì string (`'pendente'`, `'pago'`, `'atrasado'`, etc.)
  * `saldo_devedor_apos_pagamento` ‚Äì Numeric (saldo te√≥rico ap√≥s essa parcela)

---

#### 4.3. Nova tabela: `financiamento_amortizacao_extra`

Criar modelo `FinanciamentoAmortizacaoExtra` em `backend/models.py`.

Campos:

* `id` ‚Äì PK
* `financiamento_id` ‚Äì FK
* `data` ‚Äì Date
* `valor` ‚Äì Numeric
* `tipo` ‚Äì string (`'reduzir_parcela'` ou `'reduzir_prazo'`)
* Opcional: `observacoes` ‚Äì string

---

#### 4.4. Nova tabela: `indexador_mensal`

Criar tabela para guardar, no m√≠nimo, a TR mensal.

Modelo `IndexadorMensal`:

* `id` ‚Äì PK
* `nome` ‚Äì string (ex.: `'TR'`)
* `data_referencia` ‚Äì Date ou YearMonth (usar Date com dia 1)
* `valor` ‚Äì Numeric

Essa tabela ser√° usada para atualizar o saldo devedor do financiamento com base na TR.

---

### 5. L√≥gica de neg√≥cio a ser implementada

Criar um novo arquivo de servi√ßo chamado `backend/services/financiamento_service.py` e, se necess√°rio, atualizar `backend/services/__init__.py` para expor o servi√ßo.

A l√≥gica deve incluir, no m√≠nimo:

#### 5.1. Cria√ß√£o de um financiamento

Fun√ß√£o sugerida:

```python
class FinanciamentoService:

    def criar_financiamento(self, dados_financiamento):
        """
        Cria o contrato de financiamento, persiste no banco e gera a tabela de parcelas.
        """
```

Passos:

1. Validar dados de entrada.
2. Criar inst√¢ncia de `Financiamento` e salvar.
3. Chamar `self.gerar_parcelas(financiamento)`.

---

#### 5.2. Gera√ß√£o das parcelas

Criar m√©todo:

```python
def gerar_parcelas(self, financiamento):
    """
    Gera a tabela de amortiza√ß√£o completa, de acordo com o sistema de amortiza√ß√£o:
    - SAC
    - PRICE
    - SIMPLES
    Aplica TR mensal (quando configurado) e comp√µe a presta√ß√£o com seguros e taxas.
    """
```

* Se `sistema_amortizacao == 'SAC'`:

  * Amortiza√ß√£o constante = `valor_financiado / prazo_total_meses`.
  * Para cada m√™s:

    * Ler TR na tabela `IndexadorMensal` (se existir).
    * Atualizar saldo anterior: `saldo_corrigido = saldo_anterior * (1 + TR)`.
    * Calcular juros: `juros = saldo_corrigido * taxa_juros_mensal`.
    * Calcular seguro do m√™s (pode ser par√¢metro fixo mensal, ex.: 182,88).
    * Calcular taxa administrativa (ex.: 25,00).
    * Montar valor total previsto da parcela:

      ```python
      valor_previsto_total = amortizacao + juros + seguro + taxa_adm
      ```
    * Preencher campos de `FinanciamentoParcela` e o saldo devedor ap√≥s pagamento.

* Se `sistema_amortizacao == 'PRICE'`:

  * Implementar f√≥rmula PMT cl√°ssica para calcular a parcela fixa.
  * Quebrar a parcela em juros e amortiza√ß√£o a cada m√™s.
  * Ainda compor com seguro e taxa.

* Se `sistema_amortizacao == 'SIMPLES'`:

  * Implementar l√≥gica de juros simples conforme especificado.

---

#### 5.3. Integra√ß√£o com contas a pagar

* Sempre que gerar uma parcela, criar (se configurado) uma **conta a pagar** correspondente, na tabela j√° existente de contas, vinculando por `conta_id`.
* A data de vencimento deve refletir a data da parcela.
* O valor da conta deve ser `valor_previsto_total`.

---

#### 5.4. Registro de pagamento de parcela

Fun√ß√£o sugerida:

```python
def registrar_pagamento_parcela(self, parcela_id, valor_pago, data_pagamento):
    """
    Atualiza a parcela como paga, integra com o m√≥dulo de contas a pagar
    e calcula o DIF entre o valor previsto e o valor pago.
    """
```

Passos:

1. Carregar `FinanciamentoParcela`.
2. Atualizar `valor_pago`, `status` e integrar com o registro de pagamento j√° existente (se houver).
3. Calcular `dif_apurada = valor_previsto_total - valor_pago`.
4. Atualizar saldo devedor te√≥rico se o sistema for SAC/PRICE.

---

#### 5.5. Amortiza√ß√µes extraordin√°rias

Fun√ß√£o sugerida:

```python
def registrar_amortizacao_extra(self, financiamento_id, dados_amortizacao):
    """
    Registra uma amortiza√ß√£o extraordin√°ria e recalcula a tabela de parcelas futura.
    """
```

Passos:

1. Criar registro em `FinanciamentoAmortizacaoExtra`.
2. Atualizar saldo devedor do financiamento.
3. Recalcular as parcelas futuras, de acordo com o tipo:

   * **reduzir_parcela:** mant√©m prazo, reduz valor das parcelas futuras.
   * **reduzir_prazo:** mant√©m valor das parcelas, diminui quantidade de meses.
4. Para recalcular, utilizar m√©todo dedicado `recalcular_tabela_a_partir(parcela_inicial)`.

---

### 6. Rotas da API a serem criadas

Criar arquivo `backend/routes/financiamentos.py` (seguindo o padr√£o de `consorcios.py`, `despesas.py`, etc.) com rotas REST:

* `GET /api/financiamentos`

  * Lista geral de financiamentos.
* `POST /api/financiamentos`

  * Cria um novo financiamento e gera automaticamente as parcelas.
* `GET /api/financiamentos/<int:id>`

  * Detalhes de um financiamento, incluindo resumo das parcelas.
* `PUT /api/financiamentos/<int:id>`

  * Atualiza dados gerais do financiamento.
* `DELETE /api/financiamentos/<int:id>`

  * Soft delete (marca `ativo=False`).
* `POST /api/financiamentos/<int:id>/regenerar-parcelas`

  * Regenera todas as parcelas a partir do estado atual do contrato.
* `POST /api/financiamentos/<int:id>/amortizacao-extra`

  * Registra uma amortiza√ß√£o extraordin√°ria.
* `POST /api/financiamentos/parcelas/<int:parcela_id>/pagar`

  * Registra o pagamento de uma parcela espec√≠fica (integra com m√≥dulo de execu√ß√£o).
* Rotas de consulta para relat√≥rios:

  * `GET /api/financiamentos/<int:id>/demonstrativo-anual?ano=2024`
  * `GET /api/financiamentos/<int:id>/evolucao-saldo`

Atualizar `backend/routes/__init__.py` ou `app.py` para registrar o blueprint de financiamentos, se necess√°rio.

---

### 7. Migra√ß√µes

1. Ap√≥s criar/alterar os modelos, gerar migra√ß√£o com Flask-Migrate:

   * Comandos a serem sugeridos para o usu√°rio:

     ```bash
     flask db migrate -m "Adiciona tabelas de financiamento e indexador_mensal"
     flask db upgrade
     ```
2. O arquivo de migra√ß√£o deve:

   * Criar as novas tabelas (`financiamento`, `financiamento_parcela`, `financiamento_amortizacao_extra`, `indexador_mensal`).
   * Criar FKs e √≠ndices.
3. Implementar tamb√©m o m√©todo `downgrade` para remover as tabelas em caso de rollback.

---

### 8. Frontend ‚Äì telas e componentes

Trabalhar nos arquivos da pasta `frontend/` (`templates/`, `static/js/app.js`, `static/css/style.css`) seguindo o padr√£o j√° existente.

Criar ou atualizar:

#### 8.1. Menu / Navega√ß√£o

* Adicionar entrada ‚Äú**Financiamentos**‚Äù no menu lateral/principal.

#### 8.2. P√°gina principal de Financiamentos

Rota (por exemplo): `/financiamentos`

Elementos:

* Tabela/lista de financiamentos:

  * Nome
  * Produto
  * Sistema de amortiza√ß√£o
  * Valor financiado
  * Saldo devedor atual
  * Prazo remanescente
  * A√ß√µes: Ver Detalhes, Registrar Amortiza√ß√£o Extra, Ver Demonstrativo

* Bot√£o ‚ÄúNovo Financiamento‚Äù abrindo modal para cria√ß√£o:

  * Campos: nome, produto, sistema de amortiza√ß√£o, valor, taxas, prazo, data da primeira parcela, etc.

#### 8.3. P√°gina de detalhes do financiamento

Similar √† tela da CAIXA (‚ÄúMeu Financiamento‚Äù):

* Box com:

  * N√∫mero do contrato (interno)
  * Produto
  * Valor financiado
  * Prazo total
  * Prazo remanescente
  * Saldo devedor te√≥rico
  * Juros nominais vigentes
  * Juros efetivos contratados
  * Indexador (TR)

* Bot√µes de a√ß√£o:

  * **Debitar/Registrar pagamento da presta√ß√£o**
  * **Alterar vencimento (opcional, se fizer sentido)**
  * **Amortizar**
  * **Liquidar (quitar)**

#### 8.4. Tabela de parcelas (cronograma)

* Tabela com:

  * N¬∫ parcela
  * Data vencimento
  * Amortiza√ß√£o
  * Juros
  * Seguro
  * Taxa adm
  * Valor total previsto
  * Valor pago
  * DIF
  * Saldo devedor ap√≥s pagamento
  * Status

#### 8.5. Demonstra√ß√£o anual

P√°gina ou modal para exibir algo semelhante ao ‚ÄúDemonstrativo de Valores Cobrados ‚Äì Ano Base 2024‚Äù:

* Filtro de ano
* Agrupamento por m√™s
* Soma dos componentes da coluna A, B, C, D, E conforme demonstrativo da CAIXA.

---

### 9. Testes

Criar testes em `tests/`:

1. Testes de cria√ß√£o de financiamento e gera√ß√£o de parcelas:

   * Verificar se o n√∫mero de parcelas est√° correto.
   * Verificar se a soma das amortiza√ß√µes √© igual ao valor financiado (desconsiderando efeitos de TR).
2. Testes de amortiza√ß√£o extraordin√°ria:

   * Verificar se o saldo diminui corretamente.
   * Verificar se as parcelas futuras foram recalculadas.
3. Testes de rotas:

   * `POST /api/financiamentos`
   * `GET /api/financiamentos/<id>`
   * `POST /api/financiamentos/<id>/amortizacao-extra`
4. Testar gera√ß√£o de demonstrativos via API.

---

### 10. Estilo de resposta da IA (sempre)

Ao executar qualquer etapa descrita acima:

1. Diga claramente qual **fase** voc√™ est√° implementando (ex.: ‚ÄúFase 2 ‚Äì Modelos e Migra√ß√µes‚Äù).
2. Liste os arquivos que ser√£o alterados/criados.
3. Mostre o c√≥digo **organizado por arquivo**, com t√≠tulos como:

   * `backend/models.py`
   * `backend/services/financiamento_service.py`
   * `backend/routes/financiamentos.py`
4. Quando for reescrever trechos de arquivos grandes, mostre:

   * O **bloco completo** a ser substitu√≠do
   * E explique: ‚Äúsubstitua o trecho X por este‚Äù
5. Quando terminar uma fase, fa√ßa um mini checklist do que j√° foi feito e do que falta.

---

**Fim do documento de instru√ß√µes para a IA.**

---

Se quiser, no pr√≥ximo passo eu posso montar uma **vers√£o enxuta** desse prompt (tipo ‚Äúmodo curto‚Äù) ou uma vers√£o focada s√≥ no **backend** ou s√≥ no **frontend**, se voc√™ quiser separar o desenvolvimento em etapas diferentes.
