Showtime! üòÑ
Vou montar agora **o guia completo** no mesmo formato do anterior, pronto para voc√™ colar na IA do VSCode e deixar ela implementar o **M√≥dulo de Receitas Completo** no seu sistema de controle financeiro. (Considerando as tabelas j√° citadas no seu `README.md`: `item_receita`, `receita_orcamento`, `receita_realizada` etc. )

Vou escrever direto o documento para a IA, sem coment√°rios extras, pra voc√™ s√≥ copiar e usar.

---

## üìÑ DOCUMENTO PARA A IA DO VSCODE

**Implementa√ß√£o Completa do M√≥dulo de RECEITAS no Sistema de Controle Financeiro**

> **IMPORTANTE ‚Äì CONTEXTO INICIAL**
> Voc√™ √© uma IA integrada ao VSCode, com acesso ao reposit√≥rio de um sistema de controle financeiro pessoal desenvolvido em **Python + Flask + SQLAlchemy + SQLite**, preparado para uso futuro com PostgreSQL.
> Seu objetivo √© **implementar e aperfei√ßoar o m√≥dulo de RECEITAS**, cobrindo:
>
> * Sal√°rio mensal fixo
> * Gratifica√ß√µes (cargos em comiss√£o, fun√ß√µes, adicionais)
> * Rendas extras (ex.: c√°lculos judiciais, consultorias, aulas, etc.)
> * Outras fontes de receita classificadas pelo usu√°rio
>
> Voc√™ deve seguir rigorosamente as instru√ß√µes abaixo, mantendo o padr√£o de arquitetura e estilo existentes no projeto.

---

### 1. Papel e comportamento da IA

1. **Antes de fazer qualquer altera√ß√£o**, voc√™ deve:

   * Ler `README.md` do projeto.
   * Ler `backend/app.py`, `backend/models.py`, `backend/config.py`.
   * Ler toda a pasta `backend/routes/` e `backend/services/`.
   * Verificar se j√° existem defini√ß√µes de receitas (`item_receita`, `receita_orcamento`, `receita_realizada`) e compreender como est√£o hoje.
2. **Sempre que for propor ou aplicar mudan√ßas:**

   * Explicar em 2‚Äì5 frases o que ser√° feito.
   * Listar os arquivos que ser√£o criados/alterados.
   * Mostrar o c√≥digo organizado por arquivo, em blocos.
   * Evitar reescrever arquivos enormes quando s√≥ houver pequenas mudan√ßas; mostrar apenas os trechos relevantes e explicar onde encaixar.
3. **Manter coer√™ncia com o sistema:**

   * Usar o mesmo padr√£o de nomenclatura, organiza√ß√£o de rotas, blueprints, services e modelos j√° utilizados.
   * Reaproveitar o que j√° existe de receitas, aprimorando e n√£o reinventando se poss√≠vel.
4. **Sobre migra√ß√µes:**

   * Gerar c√≥digo de migra√ß√£o (fun√ß√µes `upgrade`/`downgrade`) compat√≠vel com Flask-Migrate.
   * Explicar quais comandos o usu√°rio deve rodar: `flask db migrate` e `flask db upgrade`.
5. **Sobre seguran√ßa e integridade:**

   * N√£o remover nem quebrar funcionalidades j√° est√°veis.
   * Qualquer refatora√ß√£o grande deve ser explicada e justificada antes.

---

### 2. Contexto resumido das RECEITAS no projeto

De acordo com a documenta√ß√£o atual:

* O sistema j√° possui:

  * Tabela `item_receita` (fontes de receita).
  * Tabela `receita_orcamento` (plano mensal de receitas).
  * Tabela `receita_realizada` (receitas efetivamente recebidas).
* Existe a distin√ß√£o entre:

  * **Proje√ß√£o (Or√ßamento)** ‚Äì o que se espera receber.
  * **Execu√ß√£o (Real)** ‚Äì o que realmente entrou.
* O foco desta tarefa √©:

  * Organizar e enriquecer o m√≥dulo de receitas.
  * permitir classifica√ß√£o detalhada (sal√°rio, gratifica√ß√£o, renda extra, etc.),
  * automatizar proje√ß√µes mensais,
  * registrar recebimentos reais,
  * integrar com dashboards e relat√≥rios.

---

### 3. Objetivo do novo m√≥dulo de Receitas

O m√≥dulo deve ser capaz de:

1. **Cadastrar fontes de receita** com tipos bem definidos:

   * Sal√°rio fixo (mensal).
   * Gratifica√ß√µes e cargos em comiss√£o.
   * Rendimentos extras (c√°lculos judiciais, consultorias, aulas, etc.).
   * Outras fontes (alugu√©is, rendimentos financeiros, etc.).
2. **Planejar receitas (Or√ßamento de Receitas)**:

   * Registrar proje√ß√µes mensais por tipo e fonte.
   * Permitir valores fixos mensais ou vari√°veis (eventuais).
3. **Registrar receitas realizadas**:

   * Registrar o recebimento real, com data, valor e conta de origem (ex.: conta sal√°rio, banco tal).
   * Comparar o planejado com o recebido.
4. **Analisar receitas**:

   * Mostrar gr√°ficos e relat√≥rios de:

     * Total por tipo (sal√°rio, gratifica√ß√£o, renda extra).
     * Confiabilidade da receita (percentual de quanto do planejado foi de fato recebido).
     * Evolu√ß√£o mensal da receita.
5. **Integrar com outras partes do sistema**:

   * Impacto no saldo geral e nas ‚Äúcaixinhas‚Äù de patrim√¥nio (quando o usu√°rio destinar parte da receita diretamente para uma caixinha).
   * Integra√ß√£o com o Dashboard principal (coluna ‚ÄúGanhar‚Äù).

---

### 4. Modelo de dados ‚Äì Revis√£o e expans√£o

Antes de criar modelos novos, voc√™ deve:

* Ler `backend/models.py`.
* Identificar as classes j√° existentes para receitas (`ItemReceita`, `ReceitaOrcamento`, `ReceitaRealizada` ou nomes equivalentes).
* Documentar rapidamente (em texto para o usu√°rio) como elas est√£o estruturadas hoje.

Depois:

#### 4.1. Ajustes/Cria√ß√£o: `ItemReceita`

Objetivo: representar cada **fonte de receita**.

Certificar-se de que `ItemReceita` (ou equivalente) possua:

* `id` ‚Äì PK
* `nome` ‚Äì string (ex.: ‚ÄúSal√°rio PMGO‚Äù, ‚ÄúGratifica√ß√£o Cargo em Comiss√£o X‚Äù, ‚ÄúC√°lculos Judiciais ‚Äì Cliente Y‚Äù)
* `tipo` ‚Äì enum/string com valores sugeridos:

  * `'SALARIO_FIXO'`
  * `'GRATIFICACAO'`
  * `'RENDA_EXTRA'`
  * `'ALUGUEL'`
  * `'RENDIMENTO_FINANCEIRO'`
  * `'OUTROS'`
* `descricao` ‚Äì texto opcional.
* `ativo` ‚Äì boolean.
* Campos opcionais de configura√ß√£o:

  * `valor_base_mensal` ‚Äì Numeric (para receitas fixas).
  * `dia_previsto_pagamento` ‚Äì Integer (ex.: 5, 10, √∫ltimo dia √∫til etc.).
  * `conta_origem_id` ‚Äì FK opcional para a conta/patrim√¥nio onde normalmente entra a receita (se j√° houver tabela de contas).

Criar relacionamentos com or√ßamento e realiza√ß√£o, se ainda n√£o existirem.

---

#### 4.2. Ajustes/Cria√ß√£o: `ReceitaOrcamento`

Objetivo: representar a **proje√ß√£o de receita** m√™s a m√™s.

Certificar-se de que esta tabela possua, no m√≠nimo:

* `id` ‚Äì PK
* `item_receita_id` ‚Äì FK para `ItemReceita`
* `ano_mes` ‚Äì string ou Date (recomendado: primeiro dia do m√™s, ex.: `2025-03-01`)
* `valor_previsto` ‚Äì Numeric
* `periodicidade` ‚Äì string (ex.: `'MENSAL_FIXA'`, `'EVENTUAL'`, `'UNICA'`)
* `observacoes` ‚Äì string opcional

Regras:

* Para sal√°rio e gratifica√ß√µes:

  * `periodicidade` normalmente `'MENSAL_FIXA'`.
  * Gerar automaticamente proje√ß√µes futuras com base em um valor base.
* Para rendas extras:

  * Podem ser `'EVENTUAL'` ou `'UNICA'` (ex.: um grande c√°lculo judicial previsto para certo m√™s).

---

#### 4.3. Ajustes/Cria√ß√£o: `ReceitaRealizada`

Objetivo: representar cada **recebimento efetivo**.

Campos recomendados:

* `id` ‚Äì PK
* `item_receita_id` ‚Äì FK para `ItemReceita`
* `data_recebimento` ‚Äì Date
* `valor_recebido` ‚Äì Numeric
* `conta_origem_id` ‚Äì FK opcional (se houver contas de origem)
* `descricao` ‚Äì string (ex.: ‚ÄúSal√°rio Maio/2025‚Äù, ‚ÄúC√°lculo judicial processo XXXXX‚Äù)
* `competencia` ‚Äì refer√™ncia ao m√™s a que essa receita se refere (ex.: `2025-05-01` para sal√°rio de maio, mesmo que pago no dia 06/06).
* `orcamento_id` ‚Äì FK opcional para `ReceitaOrcamento`, se associada a uma proje√ß√£o.
* `created_at` / `updated_at` ‚Äì timestamps (opcional, se padr√£o do projeto).

---

### 5. L√≥gica de neg√≥cio (Service de Receitas)

Criar (ou aprimorar) um servi√ßo em `backend/services/receita_service.py`.
Atualizar `backend/services/__init__.py` se necess√°rio.

O servi√ßo deve expor, no m√≠nimo, os seguintes grupos de funcionalidades:

#### 5.1. CRUD de fontes de receita (`ItemReceita`)

* Criar nova fonte de receita.
* Editar fonte.
* Ativar/desativar (soft delete).
* Listar todas, filtrando por tipo, ativo/inativo.

#### 5.2. Planejamento (Or√ßamento de Receitas)

Implementar m√©todos como:

```python
class ReceitaService:

    def criar_ou_atualizar_orcamento_mensal(self, item_receita_id, ano_mes, valor_previsto, periodicidade, observacoes=None):
        ...

    def gerar_orcamento_recorrente(self, item_receita_id, data_inicio, data_fim, valor_mensal, periodicidade='MENSAL_FIXA'):
        """
        Gera proje√ß√µes mensais autom√°ticas para um per√≠odo (ex.: 12 meses),
        especialmente √∫til para sal√°rio e gratifica√ß√µes.
        """
```

Regras:

* Para **sal√°rio fixo**:

  * Permitir gerar proje√ß√µes para 12, 24, 36 meses com um clique.
  * Se o valor mudar (reajuste), gerar a partir de certa compet√™ncia.

* Para **renda extra/judiciais**:

  * Permitido cadastrar previs√µes pontuais por m√™s.

#### 5.3. Registro de receitas realizadas

Implementar:

```python
def registrar_receita_realizada(self, dados_receita):
    """
    Cria um registro de ReceitaRealizada, vinculando ao ItemReceita
    e, se aplic√°vel, √† proje√ß√£o de ReceitaOrcamento do m√™s.
    Calcula a diferen√ßa Previsto x Real para fins de an√°lise de confiabilidade.
    """
```

Passos:

1. Identificar a compet√™ncia (m√™s de refer√™ncia).
2. Procurar se existe `ReceitaOrcamento` para aquele `item_receita_id + ano_mes`.
3. Vincular a `orcamento_id`, se encontrado.
4. Calcular diferen√ßa:

   * `dif = valor_recebido - valor_previsto` (se houver previs√£o).
5. Atualizar estat√≠sticas agregadas se necess√°rio (no pr√≥prio servi√ßo ou via consultas).

#### 5.4. Fun√ß√µes de an√°lise (relat√≥rios e KPIs)

Implementar m√©todos para uso pelo dashboard:

* `get_resumo_receitas_por_mes(ano)`

  * Retorna total de receitas previstas e realizadas por m√™s e por tipo (sal√°rio, gratifica√ß√£o, renda extra‚Ä¶).

* `get_confiabilidade_receitas(ano_mes_ini, ano_mes_fim)`

  * Calcula `% recebido / previsto` por fonte e consolidado.

* `get_detalhe_receitas_item(item_receita_id, ano)`

  * Mostra todas as proje√ß√µes e realiza√ß√µes de um item espec√≠fico (ex.: ‚ÄúSal√°rio PMGO‚Äù).

Esses m√©todos devem retornar dicion√°rios/estruturas JSON-friendly.

---

### 6. Rotas da API para Receitas

Na pasta `backend/routes/`, criar (ou aprimorar) `receitas.py` com rotas REST, seguindo o padr√£o dos demais m√≥dulos.

Rotas sugeridas:

#### 6.1. Fontes de receita (`ItemReceita`)

* `GET /api/receitas/itens`

  * Lista todas as fontes de receita.
* `POST /api/receitas/itens`

  * Cria novo item de receita.
* `PUT /api/receitas/itens/<int:id>`

  * Atualiza um item de receita.
* `DELETE /api/receitas/itens/<int:id>`

  * Soft delete (marca como inativo).

#### 6.2. Or√ßamento de receitas

* `GET /api/receitas/orcamento?ano=2025`

  * Retorna proje√ß√µes por m√™s e por item.
* `POST /api/receitas/orcamento`

  * Cria ou atualiza um or√ßamento mensal espec√≠fico.
* `POST /api/receitas/orcamento/gerar-recorrente`

  * Gera automaticamente proje√ß√µes para um intervalo de meses (√∫til para sal√°rio).

#### 6.3. Receitas realizadas

* `GET /api/receitas/realizadas?ano_mes=2025-05`

  * Lista receitas recebidas no m√™s.
* `POST /api/receitas/realizadas`

  * Registra uma nova receita recebida.
* `GET /api/receitas/realizadas/<int:id>`

  * Detalhes de uma receita.
* `DELETE /api/receitas/realizadas/<int:id>`

  * Permitir exclus√£o ou soft delete, conforme padr√£o do projeto.

#### 6.4. Relat√≥rios de receitas

* `GET /api/receitas/resumo-mensal?ano=2025`

  * Dados consolidados para gr√°ficos (previsto x realizado por m√™s).
* `GET /api/receitas/confiabilidade?ano=2025`

  * Percentuais de confiabilidade por item/tipo.
* `GET /api/receitas/itens/<int:item_id>/detalhe?ano=2025`

  * Detalhe de um √∫nico item (sal√°rio, gratifica√ß√£o, renda extra, etc.).

Registrar o blueprint de receitas em `app.py` ou arquivo de inicializa√ß√£o apropriado.

---

### 7. Migra√ß√µes

Depois de ajustar/criar os modelos:

1. Gerar migra√ß√£o via Flask-Migrate:

   * Comandos a serem executados pelo usu√°rio:

     ```bash
     flask db migrate -m "Ajustes no m√≥dulo de receitas (itens, or√ßamento, realizadas)"
     flask db upgrade
     ```

2. No arquivo de migra√ß√£o, garantir:

   * Cria√ß√£o/altera√ß√£o de colunas novas.
   * Manuten√ß√£o de dados existentes (evitar `drop` destrutivo).
   * Cria√ß√£o de √≠ndices b√°sicos em FKs com alto volume (ex.: `item_receita_id`).

3. Implementar `downgrade` para reverter as altera√ß√µes, se necess√°rio.

---

### 8. Frontend ‚Äì Telas do M√≥dulo de Receitas

Trabalhar na pasta `frontend/`, especialmente:

* `frontend/templates/` (arquivos HTML / Jinja)
* `frontend/static/js/app.js`
* `frontend/static/css/style.css`

Objetivo: criar uma experi√™ncia completa para gest√£o de receitas.

#### 8.1. Navega√ß√£o

* Incluir item **‚ÄúReceitas‚Äù** no menu principal.
* Linkar para uma p√°gina `/receitas`.

#### 8.2. P√°gina principal de Receitas

Componentes sugeridos:

1. **Resumo em cards:**

   * Total de receitas previstas no m√™s selecionado.
   * Total de receitas realizadas.
   * Diferen√ßa (super√°vit / d√©ficit).
   * Confiabilidade do m√™s (% realizado / previsto).

2. **Filtros globais:**

   * Seletor de m√™s/ano.
   * Filtro por tipo de receita (sal√°rio, gratifica√ß√£o, renda extra etc.).

3. **Tabelas/Se√ß√µes:**

   * **Fontes de receita** (lista de `ItemReceita` com tipo, valor base, etc.).
   * **Or√ßamento do m√™s** (previsto por item).
   * **Receitas realizadas** (lista de lan√ßamentos reais no m√™s).

4. **A√ß√µes r√°pidas:**

   * Bot√£o ‚ÄúAdicionar receita recebida‚Äù.
   * Bot√£o ‚ÄúPlanejar/editar or√ßamento do m√™s‚Äù.
   * Bot√£o ‚ÄúGerar proje√ß√µes futuras‚Äù (para sal√°rios/gratifica√ß√µes).

#### 8.3. Telas espec√≠ficas

* Modal ‚ÄúNova Fonte de Receita‚Äù.
* Modal ‚ÄúPlanejar Receita (Or√ßamento)‚Äù ‚Äì escolha do item, m√™s, valor previsto.
* Modal ‚ÄúRegistrar Receita Recebida‚Äù ‚Äì escolha do item, valor, data, compet√™ncia.

Os componentes de front devem se comunicar com as rotas da API definidas acima, usando o mesmo padr√£o AJAX/fetch j√° utilizado em outros m√≥dulos.

---

### 9. Integra√ß√£o com Dashboard Geral

O sistema possui uma vis√£o ‚ÄúGanhar / Planejar / Executar / Guardar‚Äù.

Atualizar o Dashboard para:

1. Consumir **resumos** do `ReceitaService` via rotas:

   * Total de receitas previstas x realizadas no per√≠odo.
   * Saldo de receitas ‚Äì despesas (se j√° houver).
2. Exibir:

   * Gr√°fico de linhas ou barras com receitas por m√™s.
   * Gr√°fico de pizza/barras com receitas por tipo.
3. Quando o usu√°rio clicar em um card de receitas, redirecionar para `/receitas` j√° filtrando o m√™s/ano clicado.

---

### 10. Testes

Na pasta `tests/`, criar testes unit√°rios para:

1. Cria√ß√£o de `ItemReceita` e associa√ß√µes.
2. Gera√ß√£o de or√ßamentos recorrentes (ex.: sal√°rio por 12 meses).
3. Registro de receita realizada vinculada ao or√ßamento.
4. C√°lculo de diferen√ßa previsto x realizado.
5. Endpoints principais:

   * `POST /api/receitas/itens`
   * `POST /api/receitas/orcamento`
   * `POST /api/receitas/realizadas`
   * `GET /api/receitas/resumo-mensal`

Testes podem usar banco de dados de teste (SQLite em mem√≥ria, conforme padr√£o do projeto).

---

### 11. Estilo de resposta da IA ao executar este guia

Sempre que aplicar alguma parte desta especifica√ß√£o:

1. Indicar claramente a **fase** (Ex.: ‚ÄúFase 3 ‚Äì Ajuste dos modelos de Receita‚Äù).

2. Listar arquivos alterados/criados.

3. Mostrar blocos de c√≥digo organizados por arquivo, por exemplo:

   * `backend/models.py`
   * `backend/services/receita_service.py`
   * `backend/routes/receitas.py`
   * `frontend/templates/receitas.html`

4. Quando substituir trechos, indicar:

   * ‚ÄúSubstitua o trecho X por este‚Äù

5. Ao final de cada fase, exibir um checklist r√°pido:

   * `[x] Modelos ajustados`
   * `[ ] Rotas criadas`
   * `[ ] Telas de frontend`
     etc.

---

**Fim do documento de instru√ß√µes para a IA ‚Äì M√≥dulo de Receitas.**

---

Se voc√™ quiser, no pr√≥ximo passo posso montar:

* uma vers√£o **mais curta** desse guia s√≥ para BACKEND,
* ou outro guia para **Investimentos**, **Cart√µes de Cr√©dito** ou **Dashboard**, no mesmo padr√£o.
