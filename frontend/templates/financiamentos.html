<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financiamentos - Controle Financeiro</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/financiamentos.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme-light.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>Gerenciamento de Financiamentos</h1>
            <nav class="breadcrumb">
                <a href="/">Dashboard</a> / <a href="/configuracoes">Configura√ß√µes</a> / <span>Financiamentos</span>
            </nav>
        </header>

        <main>
            <!-- Filtros -->
            <div class="filters-section">
                <div class="filter-group">
                    <label for="filtro-status">Status:</label>
                    <select id="filtro-status" onchange="carregarFinanciamentos()">
                        <option value="">Todos</option>
                        <option value="true" selected>Ativos</option>
                        <option value="false">Inativos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filtro-sistema">Sistema:</label>
                    <select id="filtro-sistema" onchange="carregarFinanciamentos()">
                        <option value="">Todos</option>
                        <option value="SAC">SAC</option>
                        <option value="PRICE">PRICE</option>
                        <option value="SIMPLES">SIMPLES</option>
                    </select>
                </div>
            </div>

            <!-- Cards de Resumo -->
            <div class="cards-resumo">
                <div class="card">
                    <h3>Total Financiado</h3>
                    <p class="valor" id="total-financiado">R$ 0,00</p>
                </div>
                <div class="card">
                    <h3>Saldo Devedor</h3>
                    <p class="valor" id="saldo-devedor">R$ 0,00</p>
                </div>
                <div class="card">
                    <h3>Parcelas Pagas</h3>
                    <p class="valor" id="parcelas-pagas">0 / 0</p>
                </div>
                <div class="card">
                    <h3>Contratos Ativos</h3>
                    <p class="valor" id="contratos-ativos">0</p>
                </div>
            </div>

            <!-- Lista de Financiamentos -->
            <div class="actions">
                <button class="btn btn-primary" onclick="abrirModalNovoFinanciamento()">
                    + Novo Financiamento
                </button>
            </div>

            <div class="lista" id="financiamentos-lista">
                <p class="loading">Carregando financiamentos...</p>
            </div>
        </main>
    </div>

    <!-- Modal: Novo Financiamento -->
    <div id="modal-financiamento" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>Novo Financiamento</h2>
                <span class="close" onclick="fecharModal('modal-financiamento')">&times;</span>
            </div>
            <form id="form-financiamento" onsubmit="salvarFinanciamento(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label for="fin-nome">Nome do Contrato *</label>
                        <input type="text" id="fin-nome" required
                               placeholder="Ex: Financiamento Im√≥vel - Caixa">
                    </div>
                    <div class="form-group">
                        <label for="fin-produto">Produto</label>
                        <input type="text" id="fin-produto"
                               placeholder="Ex: Im√≥vel, Ve√≠culo, Empr√©stimo">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="fin-sistema">Sistema de Amortiza√ß√£o *</label>
                        <select id="fin-sistema" required onchange="atualizarInfoSistema()">
                            <option value="">Selecione...</option>
                            <option value="SAC">SAC - Sistema de Amortiza√ß√£o Constante</option>
                            <option value="PRICE">PRICE - Tabela Price (parcelas fixas)</option>
                            <option value="SIMPLES">SIMPLES - Juros simples</option>
                        </select>
                        <small id="info-sistema" class="form-help"></small>
                    </div>
                    <div class="form-group">
                        <label for="fin-indexador">Indexador do Saldo</label>
                        <select id="fin-indexador">
                            <option value="">Nenhum</option>
                            <option value="TR">TR - Taxa Referencial</option>
                            <option value="IPCA">IPCA - √çndice de Pre√ßos</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="fin-valor">Valor Financiado *</label>
                        <input type="text" id="fin-valor" required
                               placeholder="R$ 0,00" onkeyup="formatarMoeda(this)">
                    </div>
                    <div class="form-group">
                        <label for="fin-prazo">Prazo Total (meses) *</label>
                        <input type="number" id="fin-prazo" required min="1"
                               placeholder="360">
                    </div>
                    <div class="form-group">
                        <label for="fin-taxa">Taxa de Juros Anual (%) *</label>
                        <input type="text" id="fin-taxa" required
                               placeholder="8.50" onkeyup="formatarPercentual(this)">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="fin-data-contrato">Data do Contrato *</label>
                        <input type="date" id="fin-data-contrato" required>
                    </div>
                    <div class="form-group">
                        <label for="fin-data-primeira">Data 1¬™ Parcela *</label>
                        <input type="date" id="fin-data-primeira" required>
                    </div>
                </div>

                <!-- Vig√™ncias de Seguro (Apenas no modo CRIA√á√ÉO) -->
                <div id="secao-vigencias-seguro">
                    <h3 style="margin: 20px; font-size: 16px; color: #1d1d1f;">Vig√™ncias de Seguro Habitacional</h3>

                    <div class="alert alert-info" style="margin: 10px 20px; padding: 12px; background: #e8f4fd; border-left: 4px solid #007aff; font-size: 13px;">
                        <strong>‚ÑπÔ∏è Vig√™ncias:</strong> Cadastre os valores do seguro ao longo do tempo. M√≠nimo 1 vig√™ncia (inicial) obrigat√≥ria.
                        Voc√™ pode adicionar at√© 3 vig√™ncias agora, e mais vig√™ncias depois no modal de gerenciamento.
                    </div>

                    <!-- Vig√™ncia 1 (Obrigat√≥ria) -->
                    <div class="form-row" style="background: #f5f5f7; padding: 15px; margin: 10px 20px; border-radius: 8px;">
                        <div class="form-group">
                            <label for="seg-data-1">Vig√™ncia 1 - Data In√≠cio *</label>
                            <input type="month" id="seg-data-1" required>
                            <small class="form-help">Primeiro m√™s do contrato (ex: 2024-05 ou use o seletor)</small>
                        </div>
                        <div class="form-group">
                            <label for="seg-valor-1">Valor Mensal (R$) *</label>
                            <input type="text" id="seg-valor-1" required
                                   placeholder="R$ 0,00" onkeyup="formatarMoeda(this)">
                        </div>
                        <div class="form-group">
                            <label for="seg-obs-1">Observa√ß√µes</label>
                            <input type="text" id="seg-obs-1" maxlength="200"
                                   placeholder="Ex: Tabela Caixa 2024">
                        </div>
                    </div>

                    <!-- Vig√™ncia 2 (Opcional) -->
                    <div class="form-row" style="padding: 15px; margin: 10px 20px; border-radius: 8px; border: 1px dashed #ccc;">
                        <div class="form-group">
                            <label for="seg-data-2">Vig√™ncia 2 - Data In√≠cio</label>
                            <input type="month" id="seg-data-2">
                            <small class="form-help">Opcional (ex: 2025-01 ou use o seletor)</small>
                        </div>
                        <div class="form-group">
                            <label for="seg-valor-2">Valor Mensal (R$)</label>
                            <input type="text" id="seg-valor-2"
                                   placeholder="R$ 0,00" onkeyup="formatarMoeda(this)">
                        </div>
                        <div class="form-group">
                            <label for="seg-obs-2">Observa√ß√µes</label>
                            <input type="text" id="seg-obs-2" maxlength="200"
                                   placeholder="Ex: Atualiza√ß√£o anual">
                        </div>
                    </div>

                    <!-- Vig√™ncia 3 (Opcional) -->
                    <div class="form-row" style="padding: 15px; margin: 10px 20px; border-radius: 8px; border: 1px dashed #ccc;">
                        <div class="form-group">
                            <label for="seg-data-3">Vig√™ncia 3 - Data In√≠cio</label>
                            <input type="month" id="seg-data-3">
                            <small class="form-help">Opcional (ex: 2026-01 ou use o seletor)</small>
                        </div>
                        <div class="form-group">
                            <label for="seg-valor-3">Valor Mensal (R$)</label>
                            <input type="text" id="seg-valor-3"
                                   placeholder="R$ 0,00" onkeyup="formatarMoeda(this)">
                        </div>
                        <div class="form-group">
                            <label for="seg-obs-3">Observa√ß√µes</label>
                            <input type="text" id="seg-obs-3" maxlength="200"
                                   placeholder="Ex: Mudan√ßa de faixa et√°ria">
                        </div>
                    </div>
                </div>

                <!-- Taxa Administrativa -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="fin-taxa-adm">Taxa Administrativa Mensal</label>
                        <input type="text" id="fin-taxa-adm"
                               placeholder="R$ 0,00" onkeyup="formatarMoeda(this)">
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="fecharModal('modal-financiamento')">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Criar e Gerar Parcelas
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Detalhes do Financiamento -->
    <div id="modal-detalhes" class="modal">
        <div class="modal-content modal-xlarge">
            <div class="modal-header">
                <h2 id="detalhes-titulo">Detalhes do Financiamento</h2>
                <span class="close" onclick="fecharModal('modal-detalhes')">&times;</span>
            </div>
            <div id="detalhes-conteudo">
                <!-- Ser√° preenchido via JS -->
            </div>
        </div>
    </div>

    <!-- Modal: Pagar Parcela -->
    <div id="modal-pagar" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Registrar Pagamento de Parcela</h2>
                <span class="close" onclick="fecharModal('modal-pagar')">&times;</span>
            </div>
            <form id="form-pagar" onsubmit="salvarPagamento(event)">
                <input type="hidden" id="pagar-parcela-id">

                <div id="pagar-info" class="info-box">
                    <!-- Informa√ß√µes da parcela -->
                </div>

                <div class="form-group">
                    <label for="pagar-data">Data do Pagamento *</label>
                    <input type="date" id="pagar-data" required>
                </div>

                <div class="form-group">
                    <label for="pagar-valor">Valor Pago *</label>
                    <input type="text" id="pagar-valor" required
                           placeholder="R$ 0,00" onkeyup="formatarMoeda(this)">
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="fecharModal('modal-pagar')">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Confirmar Pagamento
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Amortiza√ß√£o Extra -->
    <div id="modal-amortizacao" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Amortiza√ß√£o Extraordin√°ria</h2>
                <span class="close" onclick="fecharModal('modal-amortizacao')">&times;</span>
            </div>
            <form id="form-amortizacao" onsubmit="salvarAmortizacao(event)">
                <input type="hidden" id="amort-financiamento-id">

                <div class="form-group">
                    <label for="amort-data">Data *</label>
                    <input type="date" id="amort-data" required>
                </div>

                <div class="form-group">
                    <label for="amort-valor">Valor da Amortiza√ß√£o *</label>
                    <input type="text" id="amort-valor" required
                           placeholder="R$ 0,00" onkeyup="formatarMoeda(this)">
                </div>

                <div class="form-group">
                    <label for="amort-tipo">Tipo de Redu√ß√£o *</label>
                    <select id="amort-tipo" required onchange="atualizarInfoAmortizacao()">
                        <option value="">Selecione...</option>
                        <option value="reduzir_parcela">Reduzir valor da parcela (manter prazo)</option>
                        <option value="reduzir_prazo">Reduzir prazo (manter valor da parcela)</option>
                    </select>
                    <small id="info-amortizacao" class="form-help"></small>
                </div>

                <div class="form-group">
                    <label for="amort-obs">Observa√ß√µes</label>
                    <textarea id="amort-obs" rows="3"
                              placeholder="Ex: FGTS, D√©cimo terceiro, etc."></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="fecharModal('modal-amortizacao')">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Registrar Amortiza√ß√£o
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Demonstrativo Anual -->
    <div id="modal-demonstrativo" class="modal">
        <div class="modal-content modal-xlarge">
            <div class="modal-header">
                <h2 id="demo-titulo">Demonstrativo Anual</h2>
                <span class="close" onclick="fecharModal('modal-demonstrativo')">&times;</span>
            </div>
            <div class="form-group" style="margin: 0 20px 20px 20px;">
                <label for="demo-ano">Selecione o Ano:</label>
                <select id="demo-ano" onchange="carregarDemonstrativo()">
                    <!-- Ser√° preenchido via JS -->
                </select>
            </div>
            <div id="demonstrativo-conteudo">
                <p class="loading">Carregando demonstrativo...</p>
            </div>
        </div>
    </div>

    <!-- Modal: Gerenciar Seguro Habitacional -->
    <div id="modal-seguro" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>Seguro Habitacional - Vig√™ncias</h2>
                <span class="close" onclick="fecharModal('modal-seguro')">&times;</span>
            </div>

            <div style="padding: 20px;">
                <!-- Vig√™ncia Atual (Card Destaque) -->
                <h3 style="margin-bottom: 15px; font-size: 16px; color: #1d1d1f;">Vig√™ncia Atual</h3>
                <div id="seguro-vigencia-atual" style="background: #f5f5f7; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                    <p class="loading">Carregando vig√™ncia atual...</p>
                </div>

                <!-- Formul√°rio: Nova Vig√™ncia -->
                <h3 style="margin-bottom: 15px; font-size: 16px; color: #1d1d1f;">Criar Nova Vig√™ncia</h3>
                <form id="form-nova-vigencia-modal" onsubmit="salvarNovaVigencia(event)">
                    <input type="hidden" id="seguro-financiamento-id">

                    <div class="form-row">
                        <div class="form-group">
                            <label for="seguro-competencia">Compet√™ncia de In√≠cio *</label>
                            <input type="month" id="seguro-competencia" required>
                            <small class="form-help">M√™s/Ano de in√≠cio (ex: 2025-08 ou use o seletor)</small>
                        </div>
                        <div class="form-group">
                            <label for="seguro-valor">Valor Mensal (R$) *</label>
                            <input type="text" id="seguro-valor" required
                                   placeholder="R$ 0,00" onkeyup="formatarMoeda(this)">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="seguro-saldo-devedor">Saldo Devedor de Refer√™ncia (R$)</label>
                            <input type="text" id="seguro-saldo-devedor" readonly
                                   style="background: #f5f5f7; cursor: not-allowed;">
                            <small class="form-help">Preenchido automaticamente (informativo)</small>
                        </div>
                        <div class="form-group">
                            <label for="seguro-observacoes">Observa√ß√µes</label>
                            <input type="text" id="seguro-observacoes" maxlength="200"
                                   placeholder="Ex: Mudan√ßa de faixa et√°ria">
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            Criar Vig√™ncia
                        </button>
                    </div>
                </form>

                <!-- Hist√≥rico de Vig√™ncias -->
                <h3 style="margin: 25px 0 15px 0; font-size: 16px; color: #1d1d1f;">Hist√≥rico de Vig√™ncias</h3>
                <div id="seguro-historico" style="overflow-x: auto;">
                    <table class="parcelas-tabela">
                        <thead>
                            <tr>
                                <th>In√≠cio</th>
                                <th>Fim</th>
                                <th>Valor Mensal</th>
                                <th>Status</th>
                                <th>Observa√ß√µes</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="seguro-tbody-vigencias">
                            <tr>
                                <td colspan="6" class="text-center">Carregando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <div class="bottom-nav-container">
            <a href="/" class="nav-item">
                <span class="icon">‚åÇ</span>
                <span class="label">Dashboard</span>
            </a>
            <a href="/lancamentos" class="nav-item">
                <span class="icon">‚úé</span>
                <span class="label">Lan√ßamentos</span>
            </a>
            <a href="/despesas" class="nav-item">
                <span class="icon">‚ñ¨</span>
                <span class="label">DESPESAS</span>
            </a>
            <a href="/configuracoes" class="nav-item">
                <span class="icon">‚öô</span>
                <span class="label">Config</span>
            </a>
        </div>
    </nav>

    <!-- Bot√£o para visualiza√ß√£o mobile -->
    <div class="mobile-toggle">
        <button onclick="toggleMobileView()" id="mobile-btn">
            üì± Ver em Mobile
        </button>
    </div>

    <script src="{{ url_for('static', filename='js/financiamentos.js') }}"></script>
    <script>
        function toggleMobileView() {
            document.body.classList.toggle('mobile-view');
            const btn = document.getElementById('mobile-btn');
            if (document.body.classList.contains('mobile-view')) {
                btn.innerHTML = 'üíª Ver em Desktop';
            } else {
                btn.innerHTML = 'üì± Ver em Mobile';
            }
        }
    </script>
</body>
</html>
