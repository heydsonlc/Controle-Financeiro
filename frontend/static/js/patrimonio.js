const API_BASE='http://localhost:5000/api/patrimonio';let contaAtual=null;document.addEventListener('DOMContentLoaded',()=>{carregarContas();carregarTransferencias()});function mostrarAba(aba){document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));event.target.classList.add('active');document.getElementById('aba-'+aba).classList.add('active');if(aba==='transferencias')carregarTransferencias()}async function carregarContas(){try{const r=await fetch(`${API_BASE}/contas`);const d=await r.json();if(d.success){exibirContas(d.data);atualizarResumo(d.data,d.total_patrimonio)}}catch(e){mostrarErro('Erro ao carregar contas')}}function exibirContas(contas){const lista=document.getElementById('caixinhas-lista');if(!contas||contas.length===0){lista.innerHTML='<p class="empty-state">Nenhuma caixinha. Crie sua primeira!</p>';return}lista.innerHTML=contas.map(c=>criarCardConta(c)).join('')}function criarCardConta(c){const progresso=c.meta?((c.saldo_atual/c.meta)*100).toFixed(1):0;return`<div class="caixinha-card" style="--cor-conta:${c.cor}"><div class="caixinha-header"><div class="caixinha-info"><h3>${c.nome}</h3><div class="tipo">${c.tipo||'Caixinha'}</div></div><span class="caixinha-badge ${c.ativo?'':'inativo'}">${c.ativo?'ATIVA':'INATIVA'}</span></div><div class="caixinha-saldo"><div class="caixinha-saldo-label">Saldo Atual</div><div class="caixinha-saldo-valor">${formatarMoedaDisplay(c.saldo_atual)}</div>${c.meta?`<div class="caixinha-meta">${progresso}% da meta de ${formatarMoedaDisplay(c.meta)}</div>`:''}</div><div class="caixinha-actions"><button class="btn-editar" onclick="editarConta(${c.id})">‚úèÔ∏è Editar</button><button class="btn-inativar" onclick="inativarConta(${c.id})">üö´ ${c.ativo?'Inativar':'Ativar'}</button></div></div>`}function atualizarResumo(contas,total){document.getElementById('patrimonio-total').textContent=formatarMoedaDisplay(total);document.getElementById('total-caixinhas').textContent=contas.filter(c=>c.ativo).length}function abrirModalNovaConta(){contaAtual=null;document.getElementById('modal-conta-titulo').textContent='Nova Caixinha';document.getElementById('form-conta').reset();document.getElementById('conta-id').value='';document.getElementById('conta-cor').value='#28a745';abrirModal('modal-conta')}async function editarConta(id){try{const r=await fetch(`${API_BASE}/contas/${id}`);const d=await r.json();if(d.success){contaAtual=d.data;preencherFormConta(d.data);document.getElementById('modal-conta-titulo').textContent='Editar Caixinha';abrirModal('modal-conta')}}catch(e){mostrarErro('Erro ao carregar conta')}}function preencherFormConta(c){document.getElementById('conta-id').value=c.id;document.getElementById('conta-nome').value=c.nome;document.getElementById('conta-tipo').value=c.tipo||'Corrente';document.getElementById('conta-cor').value=c.cor;document.getElementById('conta-saldo-inicial').value=formatarMoedaDisplay(c.saldo_inicial);document.getElementById('conta-meta').value=c.meta?formatarMoedaDisplay(c.meta):'';document.getElementById('conta-obs').value=c.observacoes||''}async function salvarConta(e){e.preventDefault();const id=document.getElementById('conta-id').value;const dados={nome:document.getElementById('conta-nome').value,tipo:document.getElementById('conta-tipo').value,saldo_inicial:parseMoeda(document.getElementById('conta-saldo-inicial').value),meta:parseMoeda(document.getElementById('conta-meta').value)||null,cor:document.getElementById('conta-cor').value,observacoes:document.getElementById('conta-obs').value};try{const url=id?`${API_BASE}/contas/${id}`:API_BASE+'/contas';const r=await fetch(url,{method:id?'PUT':'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(dados)});const d=await r.json();if(d.success){mostrarSucesso(d.message);fecharModal('modal-conta');carregarContas()}else{mostrarErro(d.error)}}catch(e){mostrarErro('Erro ao salvar')}}async function inativarConta(id){if(!confirm('Deseja realmente inativar esta conta?'))return;try{const r=await fetch(`${API_BASE}/contas/${id}`,{method:'DELETE'});const d=await r.json();if(d.success){mostrarSucesso('Conta inativada');carregarContas()}else{mostrarErro(d.error)}}catch(e){mostrarErro('Erro ao inativar')}}async function carregarTransferencias(){try{const r=await fetch(`${API_BASE}/transferencias`);const d=await r.json();if(d.success){exibirTransferencias(d.data)}}catch(e){mostrarErro('Erro ao carregar transfer√™ncias')}}function exibirTransferencias(transf){const lista=document.getElementById('transferencias-lista');if(!transf||transf.length===0){lista.innerHTML='<p class="empty-state">Nenhuma transfer√™ncia registrada</p>';return}lista.innerHTML=transf.map(t=>`<div class="transf-card"><div class="transf-info"><div class="transf-contas"><span class="transf-conta">${t.conta_origem_nome}</span><span class="transf-seta">‚Üí</span><span class="transf-conta">${t.conta_destino_nome}</span></div><div class="transf-detalhes"><span>üìÖ ${formatarData(t.data_transferencia)}</span>${t.descricao?`<span>üìù ${t.descricao}</span>`:''}</div></div><div class="transf-valor">${formatarMoedaDisplay(t.valor)}</div><div class="transf-actions"><button onclick="deletarTransferencia(${t.id})">üóëÔ∏è</button></div></div>`).join('')}async function abrirModalNovaTransferencia(){try{const r=await fetch(`${API_BASE}/contas`);const d=await r.json();if(d.success){const contas=d.data.filter(c=>c.ativo);const options=contas.map(c=>`<option value="${c.id}">${c.nome}</option>`).join('');document.getElementById('transf-origem').innerHTML='<option value="">Selecione...</option>'+options;document.getElementById('transf-destino').innerHTML='<option value="">Selecione...</option>'+options;document.getElementById('form-transferencia').reset();document.getElementById('transf-data').valueAsDate=new Date();abrirModal('modal-transferencia')}}catch(e){mostrarErro('Erro ao carregar contas')}}async function salvarTransferencia(e){e.preventDefault();const dados={conta_origem_id:parseInt(document.getElementById('transf-origem').value),conta_destino_id:parseInt(document.getElementById('transf-destino').value),valor:parseMoeda(document.getElementById('transf-valor').value),data_transferencia:document.getElementById('transf-data').value,descricao:document.getElementById('transf-descricao').value};try{const r=await fetch(`${API_BASE}/transferencias`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(dados)});const d=await r.json();if(d.success){mostrarSucesso(d.message);fecharModal('modal-transferencia');carregarTransferencias();carregarContas()}else{mostrarErro(d.error)}}catch(e){mostrarErro('Erro ao criar transfer√™ncia')}}async function deletarTransferencia(id){if(!confirm('Deletar esta transfer√™ncia? Os saldos ser√£o revertidos.'))return;try{const r=await fetch(`${API_BASE}/transferencias/${id}`,{method:'DELETE'});const d=await r.json();if(d.success){mostrarSucesso(d.message);carregarTransferencias();carregarContas()}else{mostrarErro(d.error)}}catch(e){mostrarErro('Erro ao deletar')}}function abrirModal(modalId){document.getElementById(modalId).style.display='block'}function fecharModal(modalId){document.getElementById(modalId).style.display='none'}function formatarMoedaDisplay(v){return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v)}function formatarMoeda(input){let v=input.value.replace(/\D/g,'');v=(parseInt(v)/100).toFixed(2);input.value='R$ '+v.replace('.',',').replace(/(\d)(?=(\d{3})+\,)/g,'$1.')}function parseMoeda(v){if(!v)return 0;return parseFloat(v.replace('R$','').replace(/\./g,'').replace(',','.').trim())}function formatarData(d){return new Date(d+'T00:00:00').toLocaleDateString('pt-BR')}function mostrarSucesso(m){alert(m)}function mostrarErro(m){alert(m)}window.onclick=function(e){if(e.target.classList.contains('modal')){e.target.style.display='none'}};
